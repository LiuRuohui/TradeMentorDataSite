<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stock Analysis System</title>
    <style>
      /* =============== Layout =============== */
      :root {
        --sidebar-width: 240px;
        --bg-light: #f8fafc;
        --primary: #3b82f6;
        --primary-dark: #2563eb;
        --primary-light: #dbeafe;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --text-primary: #1f2937;
        --text-secondary: #6b7280;
        --border-color: #e5e7eb;
        --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        --card-shadow-hover: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      * {
        box-sizing: border-box;
      }
      
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: var(--text-primary);
        line-height: 1.6;
      }
      
      /* ---------- Sidebar ---------- */
      .sidebar {
        width: var(--sidebar-width);
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-right: 1px solid var(--border-color);
        padding: 2rem 1rem;
        position: fixed;
        height: 100vh;
        overflow-y: auto;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        z-index: 100;
      }
      
      .sidebar h2 {
        text-align: center;
        font-size: 1.5rem;
        margin: 0 0 2rem;
        color: var(--primary);
        font-weight: 700;
        position: relative;
      }
      
      .sidebar h2::after {
        content: '';
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        width: 40px;
        height: 3px;
        background: linear-gradient(90deg, var(--primary), var(--primary-light));
        border-radius: 2px;
      }
      
      .menu {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      
      .menu li {
        margin: 0.75rem 0;
      }
      
      .menu button {
        width: 100%;
        background: none;
        border: none;
        padding: 1rem 1.2rem;
        border-radius: 12px;
        text-align: left;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
        color: var(--text-secondary);
      }
      
      .menu button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
        transition: left 0.5s;
      }
      
      .menu button:hover::before {
        left: 100%;
      }
      
      .menu button.active,
      .menu button:hover {
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        color: #fff;
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }
      
      /* ---------- Main ---------- */
      .main {
        margin-left: var(--sidebar-width);
        padding: 2rem;
        min-height: 100vh;
        background: var(--bg-light);
        display: grid; /* 使用Grid布局 */
        grid-template-columns: 2fr 1fr; /* 左侧2/3，右侧1/3 */
        gap: 2rem; /* 间距 */
        align-items: start; /* 顶部对齐 */
      }
      
      .main-content {
        grid-column: 1 / 2; /* 占据第一列 */
      }

      .sidebar-right {
        grid-column: 2 / 3; /* 占据第二列 */
        position: sticky; /* 固定位置 */
        top: 2rem;
      }
      
      .main h1 {
        text-align: center;
        margin: 0 0 2rem;
        font-size: 2.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      /* ---------- Card ---------- */
      .card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        box-shadow: var(--card-shadow);
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: var(--transition);
      }
      
      .card:hover {
        box-shadow: var(--card-shadow-hover);
        transform: translateY(-2px);
      }
      
      .card h3 {
        margin: 0 0 1.5rem;
        color: var(--primary);
        font-size: 1.5rem;
        font-weight: 600;
      }
      
      label {
        font-weight: 600;
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
        font-size: 0.95rem;
      }
      
      input[type="text"],
      input[type="number"],
      textarea,
      select {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 1.5rem;
        font-size: 1rem;
        transition: var(--transition);
        background: rgba(255, 255, 255, 0.8);
      }
      
      input[type="text"]:focus,
      input[type="number"]:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        background: #fff;
      }
      
      textarea {
        resize: vertical;
        min-height: 100px;
      }
      
      button[type="submit"] {
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        color: #fff;
        border: none;
        padding: 0.875rem 2rem;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
      }
      
      button[type="submit"]:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
      }
      
      button[type="submit"]:active {
        transform: translateY(0);
      }
      
      button[type="submit"][disabled] {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      
      /* Checkbox styling */
      input[type="checkbox"] {
        margin-right: 0.5rem;
        transform: scale(1.2);
      }
      
      /* ---------- Results ---------- */
      pre {
        margin: 0;
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        white-space: pre-wrap;
        overflow-x: auto;
        border: 1px solid var(--border-color);
        font-size: 0.9rem;
        line-height: 1.5;
      }
      
      iframe {
        border: none;
        width: 100%;
        height: 650px;
        margin-top: 1.5rem;
        border-radius: 12px;
        box-shadow: var(--card-shadow);
      }
      
      /* ---------- Table ---------- */
      table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: var(--card-shadow);
      }
      
      th,
      td {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        text-align: left;
        font-size: 0.95rem;
      }
      
      th {
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        color: #fff;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
      }
      
      tr:hover {
        background: var(--primary-light);
      }
      
      /* ---------- Pagination ---------- */
      .pagination {
        margin: 1.5rem 0 0;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        font-size: 0.95rem;
      }
      
      .pagination button {
        padding: 0.5rem 1rem;
        background: #fff;
        border: 2px solid var(--border-color);
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: var(--transition);
      }
      
      .pagination button:hover:not(:disabled) {
        border-color: var(--primary);
        color: var(--primary);
      }
      
      .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      
      #page-info {
        font-weight: 600;
        color: var(--text-secondary);
        min-width: 120px;
        text-align: center;
      }
      
      /* ---------- Spinner ---------- */
      .spinner {
        display: inline-block;
        width: 24px;
        height: 24px;
        border: 3px solid var(--primary-light);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-left: 0.5rem;
      }
      
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      
      /* ---------- Responsive Design ---------- */
      @media (max-width: 768px) {
        .sidebar {
          width: 100%;
          height: auto;
          position: relative;
          padding: 1rem;
        }
        
        .main {
          margin-left: 0;
          padding: 1rem;
          grid-template-columns: 1fr; /* 移动端变为单列 */
        }
        
        .main-content, .sidebar-right {
          grid-column: 1 / 2; /* 全部占满 */
        }
        
        .main h1 {
          font-size: 2rem;
        }
        
        .card {
          padding: 1.5rem;
        }
      }
      
      /* ---------- Loading States ---------- */
      .loading {
        opacity: 0.7;
        pointer-events: none;
      }
      
      /* ---------- Success/Error Messages ---------- */
      .message {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        font-weight: 500;
      }
      
      .message.success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
        border: 1px solid rgba(16, 185, 129, 0.2);
      }
      
      .message.error {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
        border: 1px solid rgba(239, 68, 68, 0.2);
      }
    </style>
  </head>
  <script src="popup-integration.js"></script>
  <body>
    <!-- ================= Sidebar ================= -->
    <aside class="sidebar">
      <h2>Function Menu</h2>
      <ul class="menu">
        <li><button id="nav-single" class="active">📈 Single Stock</button></li>
        <li><button id="nav-batch">📊 Batch Analysis</button></li>
        <li><button id="nav-list">📋 Stock List</button></li>
        <li><button id="nav-forum" onclick="window.location.href='/forum/index.html'">💬 Forum</button></li>
      </ul>
    </aside>

    <!-- ================= Main ================= -->
    <main class="main">
      <div class="main-content">
        <h1>Stock Analysis System</h1>

        <!-- ===== 单只分析 ===== -->
        <section id="section-single">
          <form id="form-single" class="card">
            <h3>Single Stock Analysis</h3>
            <label for="single-code">Stock Code *</label>
            <input id="single-code" name="stock_code" placeholder="e.g., 600519 or 107.IWF" required />

            <label for="single-days">Look-back Days (default 60)</label>
            <input id="single-days" name="days" type="number" value="60" min="15" />

            <button type="submit" id="btn-single">
              <span>Start Analysis</span>
              <span id="spin-single" style="display:none" class="spinner"></span>
            </button>
          </form>

          <div id="res-single" style="display:none" class="card">
            <h3>Analysis Result</h3>
            <pre id="json-single"></pre>
            <iframe id="frame-single" style="display:none"></iframe>
          </div>
        </section>

        <!-- ===== 批量分析 ===== -->
        <section id="section-batch" style="display:none">
          <form id="form-batch" class="card">
            <h3>Batch Stock Analysis</h3>
            <label for="batch-codes">Stock Codes (comma-separated)</label>
            <textarea id="batch-codes" name="stock_codes" placeholder="e.g., 600519,000001,107.IWF"></textarea>

            <label for="batch-days">Look-back Days (default 60)</label>
            <input id="batch-days" name="days" type="number" value="60" min="15" />

            <label style="display: flex; align-items: center; margin-bottom: 1rem;">
              <input id="batch-topgains" type="checkbox" />
              <span style="margin-left: 0.5rem;">Sort by Gains</span>
            </label>

            <label for="batch-k">Top K (default 10)</label>
            <input id="batch-k" type="number" value="10" min="1" />

            <button type="submit" id="btn-batch">
              <span>Start Batch Analysis</span>
              <span id="spin-batch" style="display:none" class="spinner"></span>
            </button>
          </form>

          <div id="res-batch" style="display:none" class="card">
            <h3>Batch Result</h3>
            <pre id="json-batch"></pre>
          </div>
        </section>

        <!-- ===== 股票列表 ===== -->
        <section id="section-list" style="display:none">
          <form id="form-list" class="card">
            <h3>Stock List Management</h3>
            <label for="list-ex">Exchange (blank = all)</label>
            <select id="list-ex">
              <option value="">ALL</option>
              <option value="SH">SH</option>
              <option value="SZ">SZ</option>
              <option value="US">US</option>
            </select>

            <label style="display: flex; align-items: center; margin-bottom: 1rem;">
              <input id="list-refresh" type="checkbox" />
              <span style="margin-left: 0.5rem;">Force Refresh</span>
            </label>

            <label for="list-size">Items per page</label>
            <input id="list-size" type="number" value="100" min="10" max="1000" />

            <button type="submit" id="btn-list">
              <span>Get List</span>
              <span id="spin-list" style="display:none" class="spinner"></span>
            </button>
          </form>

          <div id="res-list" style="display:none" class="card">
            <h3>Stock List</h3>
            <div style="overflow-x:auto">
              <table>
                <thead>
                  <tr><th>Code</th><th>Name</th></tr>
                </thead>
                <tbody id="tbl-list"></tbody>
              </table>
            </div>
            <div class="pagination">
              <button id="prev-page">← Previous</button>
              <span id="page-info"></span>
              <button id="next-page">Next →</button>
            </div>
          </div>
        </section>
      </div>

      <aside class="sidebar-right" id="chatbot-container">
        <!-- 聊天框将在这里加载 -->
      </aside>
    </main>

    <script>
      /* ================= Nav ================= */
      const sections = {
        single: document.getElementById("section-single"),
        batch: document.getElementById("section-batch"),
        list: document.getElementById("section-list"),
      };
      const navButtons = {
        single: document.getElementById("nav-single"),
        batch: document.getElementById("nav-batch"),
        list: document.getElementById("nav-list"),
      };
      function show(tab) {
        Object.keys(sections).forEach((k) => {
          sections[k].style.display = k === tab ? "block" : "none";
          navButtons[k].classList.toggle("active", k === tab);
        });
      }
      navButtons.single.onclick = () => show("single");
      navButtons.batch.onclick = () => show("batch");
      navButtons.list.onclick = () => show("list");

      /* ================= 单只分析 ================= */
      const fSingle = document.getElementById("form-single");
      fSingle.addEventListener("submit", async (e) => {
        e.preventDefault();
        toggle("single", true);
        const payload = {
          stock_code: document.getElementById("single-code").value.trim(),
          days: Number(document.getElementById("single-days").value) || 60,
        };
        try {
          const r = await fetch("/analyze/single", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await r.json();
          if (!r.ok) throw new Error(data.detail || "服务器错误");
          document.getElementById("json-single").textContent = JSON.stringify(
            data,
            null,
            2
          );
          document.getElementById("res-single").style.display = "block";
          // 轮询等待图表
          if (data.chart_url) {
            await waitForReady(data.chart_url, "spin-single");
            const abs = data.chart_url.startsWith("http")
              ? data.chart_url
              : location.origin + data.chart_url;
            const frame = document.getElementById("frame-single");
            frame.src = abs;
            frame.style.display = "block";
          }
        } catch (err) {
          alert(err.message);
        } finally {
          toggle("single", false);
        }
      });

      /* ================= 批量分析 ================= */
      const fBatch = document.getElementById("form-batch");
      fBatch.addEventListener("submit", async (e) => {
        e.preventDefault();
        toggle("batch", true);
        const payload = {
          stock_codes: document
            .getElementById("batch-codes")
            .value.split(/[,，\s]+/)
            .filter(Boolean),
          days: Number(document.getElementById("batch-days").value) || 60,
          topgains: document.getElementById("batch-topgains").checked,
          k: Number(document.getElementById("batch-k").value) || 10,
        };
        try {
          const r = await fetch("/analyze/batch", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await r.json();
          if (!r.ok) throw new Error(data.detail || "服务器错误");
          document.getElementById("json-batch").textContent = JSON.stringify(
            data,
            null,
            2
          );
          document.getElementById("res-batch").style.display = "block";
        } catch (err) {
          alert(err.message);
        } finally {
          toggle("batch", false);
        }
      });

      /* ================= 股票列表 ================= */
      let curPage = 1;
      let pageSize = 100;
      let curEx = "";
      let needRefresh = false;
      document.getElementById("form-list").addEventListener("submit", (e) => {
        e.preventDefault();
        curPage = 1;
        fetchList();
      });
      document.getElementById("prev-page").onclick = () => {
        if (curPage > 1) {
          curPage--; 
          renderPage();
        }
      };
      document.getElementById("next-page").onclick = () => {
        curPage++; 
        renderPage();
      };

      let listRows   = [];     // 后端一次性返回的所有行
      let totalPages = 1;      // 由 count / pageSize 计算

      async function fetchList() {
        curEx = document.getElementById("list-ex").value;
        pageSize = Number(document.getElementById("list-size").value) || 100;
        needRefresh = document.getElementById("list-refresh").checked;
        toggle("list", true);
        try {
          const payload = {
            exchange: curEx || undefined,
            page: curPage,
            page_size: pageSize,
            refresh: needRefresh,
          };
          const r = await fetch("/stocks/list", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await r.json();
          if (!r.ok) throw new Error(data.detail || "服务器错误");
          listRows   = data.data;                 // 缓存在前端
          totalPages = Math.max(1, Math.ceil(data.count / pageSize));
          renderPage();                           // 只渲染本页
          document.getElementById("res-list").style.display = "block";
          // renderTable(data.data);
          // document.getElementById("page-info").textContent = `第 ${curPage} 页 / 共 ${Math.ceil(
          //   data.count / pageSize
          // )} 页`;
        } catch (err) {
          alert(err.message);
        } finally {
          toggle("list", false);
        }
      }
      function renderTable(rows) {
        const tbody = document.getElementById("tbl-list");
        tbody.innerHTML = rows
          .map((r) => `<tr><td>${r.code}</td><td>${r.name}</td></tr>`) // eslint-disable-line
          .join("");
      }
      function renderPage() {
        /* 计算当前页需要展示的切片 */
        const start = (curPage - 1) * pageSize;
        const end   = start + pageSize;
        const pageRows = listRows.slice(start, end);

        /* 渲染表格 */
        const tbody = document.getElementById("tbl-list");
        tbody.innerHTML = pageRows
          .map(r => `<tr><td>${r.code}</td><td>${r.name}</td></tr>`)
          .join("");

        /* 更新分页信息 & 按钮状态 */
        document.getElementById("page-info").textContent =
          `第 ${curPage} 页 / 共 ${totalPages} 页`;

        document.getElementById("prev-page").disabled = curPage <= 1;
        document.getElementById("next-page").disabled = curPage >= totalPages;
      }

      /* ================= 工具函数 ================= */
      function toggle(scope, loading) {
        document.getElementById(`btn-${scope}`).disabled = loading;
        document.getElementById(`spin-${scope}`).style.display = loading
          ? "inline-block"
          : "none";
      }
      async function waitForReady(url, spinId, interval = 1500, times = 15) {
        const full = url.startsWith("http") ? url : location.origin + url;
        const spin = document.getElementById(spinId);
        for (let i = 0; i < times; i++) {
          try {
            const res = await fetch(full, { method: "HEAD" });
            if (res.ok) return true;
          } catch (_) {}
          await new Promise((r) => setTimeout(r, interval));
        }
        spin.style.display = "none";
        alert("图表生成超时，请稍后手动刷新页面查看");
        return false;
      }
    </script>
  </body>
</html>
